/*******************************************************************************
* Title                 :   ------
* Filename              :   pid_ctrl.c
* Author                :   Carlos Herrera Trujillo
* Origin Date           :   Jun 10, 2024
* Version               :   x.0.0
* Compiler              :   ------
* Target                :   STM32XXX
* Notes                 :   
*******************************************************************************/

/******************************************************************************
* Private Preprocessor Constants
*******************************************************************************/


/******************************************************************************
* Private Includes
*******************************************************************************/
#include "pid_ctrl.h"
#include <stdint.h>


/******************************************************************************
* Private defines
*******************************************************************************/


/******************************************************************************
* Private Typedefs
*******************************************************************************/


/******************************************************************************
* Private Macros
*******************************************************************************/


/******************************************************************************
* Public Variables
*******************************************************************************/


/******************************************************************************
* Private Variables
*******************************************************************************/


/******************************************************************************
* Private Function Prototypes
*******************************************************************************/


/******************************************************************************
* Public Function Prototypes
*******************************************************************************/


/////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////Definitions/////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////


/******************************************************************************
* Private Function Definitions
*******************************************************************************/


/******************************************************************************
* Public Function Definitions
*******************************************************************************/

void pidInit( pidConfig_t* config, pidState_t* state )
{
	state->pastD = 0;
	state->pastY = 0;
	state->futureI = 0;
}

float pidControl( pidConfig_t* config, pidState_t* state, float y, float r )
{
	   float P = 0;
	   float D = 0;
	   float I = 0;
	   float U = 0;

	   /*----- Calculate controller's output U ----------------------------------*/

	   // P[k] = Kp * (b*r[k] - y[k]);
	   P = config->Kp * (config->b * r - y);

	   // D[k] = (Kd/(Kd + N*h)) * D[k-1] - (N*h*Kd/(Kd+N*h)) * (y[k]-y[k-1]);
	   D = ( config->Kd * state->pastD - config->N * config->h * config->Kd * (y - state->pastY) ) / (config->Kd + config->N * config->h);

	   // I[k] se calculo en la enterior iteracion (en la primera se asume 0)
	   I = state->futureI;

	   // U[k] = P[k] + I[k] + D[k]
	   U = P + I + D;

	   /*----- Update controller for next iteration -----------------------------*/

	   state->pastD = D;
	   state->pastY = y;
	   // I[k+1] = I[k] + Ki*h*e[k], con e[k] = r[k] - y[k]
	   state->futureI = I + config->Ki * config->h * (r - y);

	   /*----- Return controller's output U -------------------------------------*/
	   return U;
}

/////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////
/*************** END OF FUNCTIONS *********************************************/
